// src/lib/services/news-service.ts
import { supabase, getServiceSupabase, NewsRow, NewsInsert } from '@/lib/db/supabase';
import { NewsArticle } from '@/types/news';

/**
 * Save news articles to Supabase
 * Uses upsert to handle duplicates (based on source_url)
 */
export async function saveNewsToSupabase(articles: Partial<NewsArticle>[]): Promise<{
    saved: number;
    errors: number;
}> {
    const db = getServiceSupabase();
    let saved = 0;
    let errors = 0;

    for (const article of articles) {
        try {
            const newsData: NewsInsert = {
                title: article.title || '',
                title_kr: article.titleKr || null,
                content: article.description || null,
                content_kr: null,
                summary: null,
                summary_kr: null,
                source: article.source || 'unknown',
                source_url: article.url || '',
                author: article.author || null,
                image_url: article.image || null,
                published_at: article.published || new Date().toISOString(),
            };

            const { error } = await db
                .from('news')
                .upsert(newsData, { onConflict: 'source_url' });

            if (error) {
                console.error('Error saving news:', error);
                errors++;
            } else {
                saved++;
            }
        } catch (err) {
            console.error('Error processing article:', err);
            errors++;
        }
    }

    return { saved, errors };
}

/**
 * Get news from Supabase
 */
export async function getNewsFromSupabase(options: {
    limit?: number;
    offset?: number;
    source?: string;
} = {}): Promise<NewsArticle[]> {
    const { limit = 20, offset = 0, source } = options;

    let query = supabase
        .from('news')
        .select('*')
        .order('published_at', { ascending: false })
        .range(offset, offset + limit - 1);

    if (source) {
        query = query.eq('source', source);
    }

    const { data, error } = await query;

    if (error) {
        console.error('Error fetching news:', error);
        return [];
    }

    // Convert Supabase rows to NewsArticle format
    return (data as NewsRow[]).map(row => ({
        id: row.id,
        title: row.title,
        titleKr: row.title_kr || row.title,
        description: row.content || row.summary || '',
        contentKr: row.content_kr || undefined, // 본문 번역 추가
        url: row.source_url,
        image: row.image_url || undefined,
        published: row.published_at,
        source: row.source as any,
        author: row.author || undefined,
        categories: [],
    }));
}

/**
 * Get a single news article by ID
 */
export async function getNewsById(id: string): Promise<NewsArticle | null> {
    const { data, error } = await supabase
        .from('news')
        .select('*')
        .eq('id', id)
        .single();

    if (error || !data) {
        console.error('Error fetching news by id:', error);
        return null;
    }

    const row = data as NewsRow;
    return {
        id: row.id,
        title: row.title,
        titleKr: row.title_kr || row.title,
        description: row.content || row.summary || '',
        url: row.source_url,
        image: row.image_url || undefined,
        published: row.published_at,
        source: row.source as any,
        author: row.author || undefined,
        categories: [],
    };
}

/**
 * Get news count
 */
export async function getNewsCount(source?: string): Promise<number> {
    let query = supabase
        .from('news')
        .select('*', { count: 'exact', head: true });

    if (source) {
        query = query.eq('source', source);
    }

    const { count, error } = await query;

    if (error) {
        console.error('Error getting news count:', error);
        return 0;
    }

    return count || 0;
}

/**
 * Update news content with translation
 */
export async function updateNewsTranslation(id: string, titleKr: string, contentKr?: string): Promise<boolean> {
    const db = getServiceSupabase();

    const { error } = await db
        .from('news')
        .update({
            title_kr: titleKr,
            content_kr: contentKr,
            updated_at: new Date().toISOString(),
        })
        .eq('id', id);

    if (error) {
        console.error('Error updating news translation:', error);
        return false;
    }

    return true;
}
